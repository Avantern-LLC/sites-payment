# Техническая реализация эквайринга на сайтах

---

### Описание логики работы

   1. Клиент заполняет форму оплаты на сайте и нажимает **оплатить**
   
   2. На сайте создается неактивный инфоблок. **ID** инфоблока на сайте *https://pay.avantern.ru* имеет номер **6**, на сайте *https://avtt.ru* - **15**
   
   3. Клиент перенаправляется на платежный шлюз, где вносит и подтверждает данные карты
   
   4. Платежный шлюз отправляет данные в банк, проводит 3DS при необходимости и возвращает статус платежа
   
       > - если платеж прошел успешно, клиент переходит на шаг **4**
    
       > - если в платеже отказано - платежный шлюз сообщает об этом клиенту, а также выводит причину отказа. Редиректов со страницы оплаты ***не происходит***
  
   1. Платежный шлюз редиректит клиента обратно на сайт
   
   2. На сайте запускается скрипт [index.php](https://github.com/Avantern-LLC/sites-payment/blob/release/pay.avantern/index.php)
   
   3. В скрипт передается **id заказа**, полученный из адресной строки (id заказа формируется автоматически функцией *time()*)
   
   4. Скрипт находит элемент инфоблока с данным id и посредством запроса *GetAdvancedStatus* получает подтверждение оплаты
   
   5.  Скрипт отправляет запрос облачной кассе на формирование чека, в ответ получает *UUID принтера*
   
   6.  Статус платежа записывается в свойство элемента инфоблока *STATUS*, UUID принтера - в *UID_NUMBER*
   
   7.  Инфоблок становится активным


![](https://drive.google.com/file/d/1Gzbgrvivlr2XjCSwc5ELbNtHvlTdiHEO/view?usp=share_link)

#### **ВАЖНО**:<br>

Если клиент после успешной оплаты закрывает страницу платежного шлюза, не дождавшись перехода обртано на сайт, получает отказ от банка в платежном шлюзе или просто закрывает сессию браузера - скрипт [index.php](https://github.com/Avantern-LLC/sites-payment/blob/release/pay.avantern/index.php) не отрабатывает.<br>

В таком случае по крону запускается скрипт [check.php](https://github.com/Avantern-LLC/sites-payment/blob/release/pay.avantern/check.php)

---

### Описание логики работы [check.php](https://github.com/Avantern-LLC/sites-payment/blob/release/pay.avantern/check.php)

   1. Из инфоблока выбираются все **неактивные** элементы, **изменные** в течении последних нескольких дней (задается в *$arFilter*) и формируются в массив
   
   2. В цикле по каждому элементу, у которого значение свойства *UID_NUMBER* отсутсвует (т.е. чек не был сформирован), в платежный шлюз отправляется запрос *GetAdvancedStatus* с **id заказа**, полученного из значения свойства элемента инфоблока *NUMBER_PAY*
   
   3. На основании полученного от платежного шлюза статуса выполняется следующее:
   
       > * Статус платежа - успешно (**charged**)

       >>  1. Отправляется запрос на формирование чека в облачную кассу, в ответ получает *UUID принтера*

       >>  2. Статус платежа записывается в свойство элемента инфоблока *STATUS*, UUID принтера - в *UID_NUMBER*

       >>  3. Инфоблок становится **активным**

       > * Статус платежа - отклонено (**Rejected**)

       >>  1. Статус платежа записывается в свойство элемента инфоблока *STATUS*, а в *UID_NUMBER* записывается **payment_rejected**

       >>  2. Инфоблок становится **активным**

       > * Платежный шлюз не вернул статус (платеж с таким *order_id* не найден)

       >>  1. В *UID_NUMBER* записывается **payment_not_found**

       >>  2. Инфоблок становится **активным**

       > * Платежный шлюз вернул любой другой статус (не **charged** и не **Rejected**)

       >>  1. Статус платежа записывается в свойство элемента инфоблока *STATUS*

       >>  2. Инфоблок остается **деактивированным**, чтобы попасть в слудующий запуск крона (особенно полезно при статусе платежа **pending**)
   
### *Notice*

  > - Скрипт [check.php](https://github.com/Avantern-LLC/sites-payment/blob/release/pay.avantern/check.php) также полезен в том случае, если в момент совершения оплаты не удалось выполнить фискализацию, чек не был сформирован (например, если ФН не был доступен)

  > - Если по какой-либо причине требуется повторно обработать какой-либо старый элемент - необходимо его деактивировать и очистить значение свойства *UID_NUMBER*

---